# CVE-2017-0208

- Fix: Apr 2017
- Credit: bee13oy of CloverSec Labs

## PoC

PoC from the [fix](https://github.com/Microsoft/ChakraCore/pull/2834/commits/54d6d085987e2c399863940179db67b594d7f0a3)

```javascript
var str = "+".repeat(0x80000000);
str = str.replace(str, "+");
```

## Notes

* `JavascriptString::m_charLength` is of type `charcount_t` (`uint32_t`) but the maximum character length is defined as: `static const charcount_t MaxCharLength = INT_MAX - 1;  // Max number of chars not including '\0'.`.
* the `repeat` methods uses UInt32 arithmetic on its `count` parameter and `currentLength` of the string to be repeated to calculate the length of the new string, meaning larger than `INT_MAX - 1` values can be created without an  overflow exception.
* the `JavascriptString` constructor sets `m_charLength` from its argument directly, the Assert it contains to check if it's below `MaxCharLength` isn't compiled into Release builds.
* some (?) string operations use `int` to represent string lengths, meaning negative values when operating on an overly large string (such as 0x80000000 in the PoC). We crash in `JavascriptString::IndexOfUsingJmpTable` because the negative value is sign-extended and added to a pointer, resulting in an OOB access.
* the fix is to use the `JavascriptString::SetLength` (which contains a proper check) in the `JavascriptString` constructor instead of setting the value directly. Also convert the arguments of `JavascriptString::LastIndexOfUsingJmpTable` and `JavascriptString::IndexOfUsingJmpTable` to `charcount_t` for good measure.

## Reference

-  [Microsoft](https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2017-0208)
- [Fix](https://github.com/Microsoft/ChakraCore/pull/2834/commits/54d6d085987e2c399863940179db67b594d7f0a3)
